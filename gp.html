<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta content="initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes, width=device-width" name="viewport">

		<link rel="icon" href="https://v4.bootcss.com/docs/4.6/assets/img/favicons/favicon-32x32.png" sizes="32x32" type="image/png">
		<link rel="icon" href="https://v4.bootcss.com/docs/4.6/assets/img/favicons/favicon-16x16.png" sizes="16x16" type="image/png">
		<title>Awesome</title>
		<style>
			body{
				/* color:#d83139; */
				background-color: #404040;
				margin: 0 auto;
				width: 100%;
				max-width: 600px;
				-webkit-font-smoothing: antialiased;
				font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu,"Helvetica Neue",Arial,sans-serif;
			}
			table {
				min-width: 200px;
				width: 100%;
			}
			th {
				/* background-color: #585858; */
				background-color: #303030;
				color: #cecece;
				font-size: 14px;
				padding: 6px 6px 6px 6px;
				/* border-bottom: 1px solid #C1DAD7; */
				text-align: center;
			}
			td {
				background-color: #505050;
				color: #ddd;
				font-size: 14px;
				text-align: center;
				padding: 6px 6px 6px 6px;
				border-bottom: 1px solid #949e9d;
			}


			* {
				margin: 0;
				padding: 0;
			}

			.head-bar {
				width: 100%;
				height: 60px;
				background-color: #7952b3;
				/* border-bottom: 1px solid #C1DAD7; */
			}
			.btn button {
				background-color: #7952b3;
				border: 0 solid;
				border-radius: 5px;
				margin: 15px 0 0 10px;
				height: 30px;
				width: 60px;
				color: #C1DAD7;
				font-size: 14px;
			}
			.btn-cancel button {
				background-color: #6c757d;
				border: 0 solid;
				border-radius: 5px;
				margin: 15px 0 0 10px;
				height: 30px;
				width: 60px;
				color: #C1DAD7;
				font-size: 14px;
			}

			.myModal {
				display: none;
				position: relative; 
				width: 100%;
				/* height: 230px; */
				margin: auto; 
				z-index: 9999;
				background-color: #303030;
				padding-bottom: 20px;
				
			}
			.modal-footer {
				margin-top: 0px;
				text-align: center;
			}
			.modal-title {
				color: white;
				padding: 12px;
				font-size: 18px;
				text-align: center;
			}

			input {
				width: 90%;
				height: 40px;
				margin-top: 12px;
				margin-left: 15px;
				background-color: #505050;
				border: #303030;
				border-radius: 5px;
				padding-left: 10px;
				color: #fff;
				font-size: 14px;
			}
			.up {
				color: #f8232e;
			}
			.down {
				color: #1cdb9f;
			}
		</style>
	</head>
	<body class="body">
		<div class="head-bar"></div>
        <table border="0" cellspacing="0" cellpadding="0">
            <thead>
                <tr>
                    <!-- <th>代码</th> -->
                    <th>股票</th>
                    <th>数量</th>
                    <th>成本</br>现价</th>
                    <th>盈亏</br>%</th>
                    <th>距本</th>
					<th>操作</th>
                </tr>
            </thead>
            <tbody id="tbody">
                
            </tbody>
        </table>
		
		<div class="btn">
			<!-- 模态框触发按钮 -->
			<button id="open">新增</button>
			<!-- 刷新现价-->
			<button id="refresh">刷新</button>
		</div>
		<!-- 模态框内容 -->
		<div id="myModal" class="myModal">
			<div class="modal-dialog" id="model" tabindex="-1">
				<h3 class="modal-title">新增股票</h3>
				<!-- <hr /> -->
				<div>
					<div><input id="code" placeholder="股票代码"/></div>
					<div><input id="count" placeholder="数量"/></div>
					<div><input id="cost" placeholder="成本"/></div>
					<div><input id="name" placeholder="名称"/ hidden></div>
					<div><input id="price" placeholder="现价"/ hidden></div>
				</div>
				<div class="modal-footer">
					<span class="btn-cancel"><button id="close">取消</button></span>
					<span class="btn"><button id="add">确认</button></span>
				</div>
			</div>
		</div>
	</body>
	<script>
		document.getElementById("model").onblur = function() {
			document.getElementById("myModal").style.display = "none"
		}
		document.getElementById("model").onfocus = function() {
			document.getElementById("myModal").style.display = "block"
		}
		document.getElementById("open").onclick = function() {
			document.getElementById("myModal").style.display = "block"
		}
		document.getElementById("close").onclick = function() {
			document.getElementById("myModal").style.display = "none"
		}
        document.getElementById("add").onclick = function() {
            code = document.getElementById("code").value
            count = document.getElementById("count").value
            cost = document.getElementById("cost").value
			if (code==''||count==''||cost==''){
				alert('代码、数量、成本不能为空！');
			} else{
				GetGP(code)
				name = document.getElementById("name").value
				price = document.getElementById("price").value
				income = ((price-cost)*count).toFixed(0)
				income_pct = ((price-cost)/cost*100).toFixed(2)
				backcost_pct = ((price-cost)/price*100).toFixed(2)
				data = {
					"code": code, "count": count, "cost": cost, "price": price,
					"name": name, "price": price, "income": income,
					"income_pct": income_pct, "backcost_pct": backcost_pct
				}

				ls = localStorage.getItem('ls') // 判断缓存中是否存在数据
				if (ls==null||ls==""){
					localStorage.setItem('ls', JSON.stringify(data));
					document.getElementById("myModal").style.display = "none";
					document.getElementById("code").value = "";
            		document.getElementById("count").value = "";
            		document.getElementById("cost").value = "";

				} else{
					localStorage.setItem('ls', localStorage.getItem('ls')+','+JSON.stringify(data));
					document.getElementById("myModal").style.display = "none";
					document.getElementById("code").value = "";
            		document.getElementById("count").value = "";
            		document.getElementById("cost").value = "";
				}
				WriteTable();
			}
        }

		// 通过接口获取股票名称和价格
		function GetGP(code) {
			var xmlhttp;
			if (window.XMLHttpRequest){
				xmlhttp = new XMLHttpRequest();
			} else{
				// IE6，IE5 浏览器执行代码
				xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
			}
			xmlhttp.onreadystatechange = function(){
				if (xmlhttp.readyState==4 && xmlhttp.status==200){
					var text =  xmlhttp.responseText;
					var data = text.split('~');
					document.getElementById("name").value = data[1];
					document.getElementById("price").value = data[3]; 
				}
			}
			xmlhttp.open("GET", "https://qt.gtimg.cn/q="+code, false);
			xmlhttp.send();
		}

		// 把数据写入表格中
		function WriteTable(){
			ls = JSON.parse('['+localStorage.getItem('ls')+']') // 字符串解析为对象
			var html = ""
			for (var i=0;i<ls.length;i++){
				// console.log(ls[i])
				data = ls[i]
				if (data['income']>=0){
					class1 = "'up'";
				} else {
					class1 = "'down'";
				}
				if (data['backcost_pct']>=0){
					class2 = "'up'";
				} else {
					class2 = "'down'";
				}
				html += "<tr>" + 
							// "<td>"+data['code']+"</td>"+
							"<td>"+data['name']+"</td>"+
							"<td>"+data['count']+"</td>"+
							"<td>"+data['cost']+"<br>"+data['price']+"</td>"+
							"<td class="+class1+">"+data['income']+"<br>"+data['income_pct']+"%</td>"+
							"<td class="+class2+">"+data['backcost_pct']+"%</td>"+
							"<td><span onclick=DelGP('"+data['code']+"')>删除</span></td>"+
						"</tr>";
			}
			document.getElementById("tbody").innerHTML = html;
		}

		// 删除缓存中指定股票
		function DelGP(code){
			ls = JSON.parse('['+localStorage.getItem('ls')+']') // 字符串解析为对象
			var str = ""
			for (var i=0;i<ls.length;i++){
				if (ls[i]['code']!=code){
					if(str==""){
						str = JSON.stringify(ls[i]);
					} else {
						str = str+','+JSON.stringify(ls[i]);
					}
				}
			}
			localStorage.setItem('ls', str);
			WriteTable();
		}

		//刷新表格中现价
		document.getElementById("refresh").onclick = function() {
			ls = JSON.parse('['+localStorage.getItem('ls')+']') // 字符串解析为对象
			var str = ""
			for (var i=0;i<ls.length;i++){
				GetGP(ls[i]['code']);
				price = document.getElementById("price").value
				ls[i]['price'] = price
				if(str==""){
					str = JSON.stringify(ls[i]);
				} else {
					str = str+','+JSON.stringify(ls[i]);
				}
			}
			localStorage.setItem('ls', str);
			WriteTable();
			alert('刷新成功！')
		}


		// 页面加载时运行
		window.onload = function(){
			ls = localStorage.getItem('ls') // 判断缓存中是否存在数据
			console.log(ls)
			if (ls!=null&&ls!=""){
				WriteTable();
			}
		};

	</script>
</html>